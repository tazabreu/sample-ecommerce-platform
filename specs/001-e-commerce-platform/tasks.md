# Tasks: E-Commerce Platform with Catalog, Shopping Cart, and Order Management

**Input**: Design documents from `/specs/001-e-commerce-platform/`
**Prerequisites**: plan.md, research.md, data-model.md, contracts/, quickstart.md
**Architecture**: Two microservices (customer-facing-service, order-management-service) with Kafka event-driven communication
**Tech Stack**: Java 21, Spring Boot 3.x, Spring Data JDBC (migrated from JPA), PostgreSQL, Redis, Kafka (Redpanda locally)

---

## üìä Current Status (Updated: 2025-10-06)

### ‚úÖ COMPLETED (76/92 tasks = 83%)
- **Phase 3.1**: Infrastructure Setup (T001-T012) - ‚úÖ 12/12
- **Phase 3.2**: Contract Tests (T013-T020) - ‚úÖ 8/8
- **Phase 3.3**: Entity Models & Repositories (T021-T029) - ‚úÖ 9/9
- **Phase 3.4**: DTOs & Mappers (T030-T033) - ‚úÖ 4/4
- **Phase 3.5**: Service Layer (T034-T041) - ‚úÖ 8/8
- **Phase 3.6**: Event Infrastructure (T042-T044) - ‚úÖ 3/3
- **Phase 3.7**: REST Controllers (T045-T050) - ‚úÖ 6/6
- **Phase 3.8**: Security Configuration (T051-T053) - ‚úÖ 3/3
- **Phase 3.9**: Data Access Modernization (T054-T055) - ‚úÖ 2/2 (T056 cancelled, T057 partial)
- **Phase 3.11**: Deployment (T064) - ‚úÖ 1/2
- **Phase 3.12**: Observability (T066-T067 merged into T091) - ‚úÖ Completed
- **Phase 3.14**: Reliability (T079-T086) - ‚úÖ Deprecated (duplicates of T087-T091)
- **Urgent Remediation** (T087-T091) - ‚úÖ 5/5

### ‚ùå REMAINING (16/92 tasks = 17%)
- **T092**: üö® **URGENT** - Increase unit test coverage on both services - **MUST DO BEFORE INTEGRATION TESTS**
- **T057**: Post-migration cleanup (minor config cleanup)
- **T058-T063**: Integration Tests (7 tests) - **BLOCKED by T092**
- **T065**: .env.example template
- **T068-T069**: Prometheus/Grafana dashboards
- **T070-T073**: Documentation (README, runbooks, validation scripts)

### üéØ RECOMMENDED NEXT STEPS
1. **T092**: üö® **URGENT** - Unit test coverage (MUST complete before integration tests)
2. **T058-T063**: Integration tests (blocked by T092 - validates end-to-end flows)
3. **T070**: Comprehensive README update
4. **T071**: Operational runbook
5. **T068-T069**: Prometheus/Grafana observability
6. **T065**: Environment variable template
7. **T057**: Minor cleanup tasks

---

## Execution Flow Summary
This tasks file was generated by analyzing:
1. Implementation plan (plan.md) - Tech stack: Java 21, Spring Boot 3.x, Maven, PostgreSQL, Redis, Kafka
2. Data model (data-model.md) - 7 entities across 2 services
3. API contracts (contracts/) - 15 customer service endpoints + 5 order service endpoints
4. Event schemas (kafka-events.md) - 2 Kafka events (OrderCreated, PaymentCompleted)
5. User journeys (quickstart.md) - Complete checkout flow and manager operations

Tasks are ordered by dependencies following TDD principles:
- Setup ‚Üí Tests ‚Üí Models ‚Üí Services ‚Üí Controllers ‚Üí Integration ‚Üí Polish
- Tests are written first and MUST FAIL before implementation
- Tasks marked [P] can be executed in parallel (different files, no dependencies)

---

## Phase 3.1: Infrastructure Setup (Priority 1)

**Purpose**: Bootstrap project structure, dependencies, and infrastructure before any code

- [X] **T001** Create parent POM with multi-module Maven project structure  
  **Files**: `pom.xml` (root), `customer-facing-service/pom.xml`, `order-management-service/pom.xml`  
  **Details**: Parent POM with dependency management (Spring Boot 3.x, Resilience4j, Testcontainers, REST Assured). Modules: customer-facing-service, order-management-service, shared-lib (optional)

- [X] **T002** [P] Create Docker Compose infrastructure file  
  **Files**: `infrastructure/docker-compose.yml`, `infrastructure/docker-compose.override.yml`  
  **Details**: PostgreSQL 15 (2 databases: customer_db, order_db), Redis 7, Redpanda (Kafka-compatible). Include health checks, volumes, and environment variables

- [X] **T003** [P] Configure Flyway database migrations for customer-facing service  
  **Files**: `customer-facing-service/src/main/resources/db/migration/V1__create_categories_table.sql`, `V2__create_products_table.sql`, `V3__create_carts_table.sql`, `V4__create_cart_items_table.sql`, `V5__create_indexes.sql`  
  **Details**: Create tables per data-model.md with constraints, indexes, and audit fields. Use UUID primary keys, foreign keys, CHECK constraints

- [X] **T004** [P] Configure Flyway database migrations for order management service  
  **Files**: `order-management-service/src/main/resources/db/migration/V1__create_order_enums.sql`, `V2__create_orders_table.sql`, `V3__create_order_items_table.sql`, `V4__create_payment_transactions_table.sql`, `V5__create_indexes.sql`, `V6__create_processed_events_table.sql`  
  **Details**: Create ENUM types (order_status, payment_status), tables with JSONB for addresses, idempotency table

- [X] **T005** [P] Create Kafka topic configuration script  
  **Files**: `infrastructure/kafka/create-topics.sh`  
  **Details**: Create topics `orders.created` and `payments.completed` with 3 partitions, retention 7 days, compression snappy. Include DLQ topics

- [X] **T006** [P] Configure customer-facing service application properties  
  **Files**: `customer-facing-service/src/main/resources/application.yml`, `application-dev.yml`, `application-test.yml`  
  **Details**: Spring Boot config (server port 8080), PostgreSQL connection, Redis connection, Kafka producer, Actuator endpoints, logging (JSON format with correlation IDs)

- [X] **T007** [P] Configure order management service application properties  
  **Files**: `order-management-service/src/main/resources/application.yml`, `application-dev.yml`, `application-test.yml`  
  **Details**: Spring Boot config (server port 8081), PostgreSQL connection, Kafka consumer (group: order-service-group, earliest offset), Actuator, Resilience4j circuit breaker for payment service

- [X] **T008** [P] Configure Resilience4j patterns in customer-facing service  
  **Files**: `customer-facing-service/src/main/java/com/ecommerce/customer/config/ResilienceConfig.java`  
  **Details**: Circuit breaker config for Kafka publishing, timeout policies (500ms for catalog queries), retry with exponential backoff

- [X] **T009** [P] Configure Resilience4j patterns in order management service  
  **Files**: `order-management-service/src/main/java/com/ecommerce/order/config/ResilienceConfig.java`  
  **Details**: Circuit breaker for payment service (3 failures ‚Üí open, 30s wait), retry policy (3 attempts, 1s-5s backoff), timeout 5s

- [X] **T010** [P] Setup Micrometer and Prometheus metrics exposure  
  **Files**: Customer and order services - `config/MetricsConfig.java`  
  **Details**: Enable `/actuator/prometheus` endpoint, custom metrics (orders created, payment success rate, cart conversions), RED method metrics (Rate, Errors, Duration)

- [X] **T011** [P] Configure Spring Boot Actuator health checks  
  **Files**: Both services - `config/ActuatorConfig.java`  
  **Details**: Health endpoints (`/actuator/health`, `/actuator/health/liveness`, `/actuator/health/readiness`), database health indicator, Kafka health indicator, Redis health indicator

- [X] **T012** [P] Setup structured logging with correlation IDs  
  **Files**: Both services - `src/main/resources/logback-spring.xml`, `config/LoggingConfig.java`  
  **Details**: JSON log format, MDC for correlation IDs (generated at controller entry), log levels (ERROR, WARN, INFO), mask PII in logs

---

## Phase 3.2: Contract Tests First (Priority 2) ‚ö†Ô∏è TDD GATE

**CRITICAL**: These tests MUST be written and MUST FAIL before Phase 3.3 implementation

### Customer-Facing Service Contract Tests

- [X] **T013** [P] Contract test for Category endpoints  
  **Files**: `customer-facing-service/src/test/java/com/ecommerce/customer/contract/CategoryContractTest.java`  
  **Details**: REST Assured tests for GET /api/v1/categories (list), POST /api/v1/categories (create with auth), GET /api/v1/categories/{id}, PUT /api/v1/categories/{id} (update with auth), DELETE /api/v1/categories/{id} (delete with auth). Validate request/response schemas per OpenAPI spec

- [X] **T014** [P] Contract test for Product endpoints  
  **Files**: `customer-facing-service/src/test/java/com/ecommerce/customer/contract/ProductContractTest.java`  
  **Details**: REST Assured tests for GET /api/v1/products (list with pagination and filters), POST /api/v1/products (create with auth), GET /api/v1/products/{id}, PUT /api/v1/products/{id} (update with auth), DELETE /api/v1/products/{id} (delete with auth). Test SKU uniqueness constraint

- [X] **T015** [P] Contract test for Cart endpoints  
  **Files**: `customer-facing-service/src/test/java/com/ecommerce/customer/contract/CartContractTest.java`  
  **Details**: REST Assured tests for GET /api/v1/carts/{sessionId}, DELETE /api/v1/carts/{sessionId}, POST /api/v1/carts/{sessionId}/items (add item), PUT /api/v1/carts/{sessionId}/items/{cartItemId} (update quantity), DELETE /api/v1/carts/{sessionId}/items/{cartItemId}. Verify subtotal calculations

- [X] **T016** [P] Contract test for Checkout endpoint  
  **Files**: `customer-facing-service/src/test/java/com/ecommerce/customer/contract/CheckoutContractTest.java`  
  **Details**: REST Assured test for POST /api/v1/checkout. Validate CustomerInfo schema (name, email, phone, shippingAddress), verify CheckoutResponse schema (orderNumber, status, message)

### Order Management Service Contract Tests

- [X] **T017** [P] Contract test for Order endpoints  
  **Files**: `order-management-service/src/test/java/com/ecommerce/order/contract/OrderContractTest.java`  
  **Details**: REST Assured tests for GET /api/v1/orders/{orderNumber} (guest lookup), GET /api/v1/orders (manager list with filters), POST /api/v1/orders/{orderNumber}/cancel (manager cancel), POST /api/v1/orders/{orderNumber}/fulfill (manager fulfill). Test order status enum validation

- [X] **T018** [P] Contract test for Health endpoints  
  **Files**: `order-management-service/src/test/java/com/ecommerce/order/contract/HealthContractTest.java`  
  **Details**: REST Assured tests for GET /actuator/health, GET /actuator/health/liveness, GET /actuator/health/readiness. Validate HealthResponse schema with components (db, kafka)

### Kafka Event Contract Tests

- [X] **T019** [P] Contract test for OrderCreatedEvent schema  
  **Files**: `customer-facing-service/src/test/java/com/ecommerce/customer/contract/OrderCreatedEventContractTest.java`  
  **Details**: Serialize OrderCreatedEvent to JSON and validate against JSON Schema. Test required fields (eventId, orderId, orderNumber, customer, items, subtotal), test field formats (UUID, ISO 8601 dates, order number pattern)

- [X] **T020** [P] Contract test for PaymentCompletedEvent schema  
  **Files**: `order-management-service/src/test/java/com/ecommerce/order/contract/PaymentCompletedEventContractTest.java`  
  **Details**: Serialize PaymentCompletedEvent to JSON for success and failure cases. Validate status enum (SUCCESS, FAILED), test conditional fields (externalTransactionId present on success, failureReason present on failure)

---

## Phase 3.3: Entity Models & Repositories (Priority 3)

**Dependencies**: Phase 3.2 contract tests must be failing before implementing

### Customer-Facing Service Entities

- [X] **T021** [P] Implement Category entity with validation  
  **Files**: `customer-facing-service/src/main/java/com/ecommerce/customer/model/Category.java`  
  **Details**: JPA entity with @Entity, @Table, UUID id (via @GeneratedValue), name (unique, @NotNull, @Size(max=100)), description (@Size(max=1000)), audit fields (createdAt, updatedAt via @CreationTimestamp, @UpdateTimestamp). One-to-Many relationship to Product

- [X] **T022** [P] Implement Product entity with optimistic locking  
  **Files**: `customer-facing-service/src/main/java/com/ecommerce/customer/model/Product.java`  
  **Details**: JPA entity with UUID id, sku (unique, @Pattern for alphanumeric), name (@NotNull, @Size(max=200)), description, price (@DecimalMin("0.01"), BigDecimal), inventoryQuantity (@Min(0)), categoryId (Many-to-One to Category), isActive (default true), @Version for optimistic locking, audit fields

- [X] **T023** [P] Implement Cart entity  
  **Files**: `customer-facing-service/src/main/java/com/ecommerce/customer/model/Cart.java`  
  **Details**: JPA entity with UUID id, sessionId (unique, @NotNull, @Size(max=100)), subtotal (BigDecimal, calculated), One-to-Many to CartItem (cascade ALL, orphanRemoval true), audit fields, expiresAt (session TTL). Business method: calculateSubtotal()

- [X] **T024** [P] Implement CartItem entity  
  **Files**: `customer-facing-service/src/main/java/com/ecommerce/customer/model/CartItem.java`  
  **Details**: JPA entity with UUID id, Many-to-One to Cart, Many-to-One to Product, quantity (@Min(1)), priceSnapshot (BigDecimal, captured at add time), subtotal (calculated), audit fields, unique constraint on (cartId, productId)

### Order Management Service Entities

- [X] **T025** [P] Implement Order entity with state machine  
  **Files**: `order-management-service/src/main/java/com/ecommerce/order/model/Order.java`  
  **Details**: JPA entity with UUID id, orderNumber (unique, pattern ORD-YYYYMMDD-NNN), customerName, customerEmail, customerPhone, shippingAddress (JSONB via @Type(JsonBinaryType.class)), subtotal (BigDecimal), status (@Enumerated OrderStatus: PENDING/PROCESSING/PAID/FULFILLED/CANCELLED/FAILED), One-to-Many to OrderItem, One-to-One to PaymentTransaction, audit fields. Business methods: canBeCancelled(), markAsPaid(), markAsFailed()

- [X] **T026** [P] Implement OrderItem entity (immutable)  
  **Files**: `order-management-service/src/main/java/com/ecommerce/order/model/OrderItem.java`  
  **Details**: JPA entity with UUID id, Many-to-One to Order, productId (UUID, no FK for historical integrity), productSku, productName, quantity (@Min(1)), priceSnapshot (BigDecimal), subtotal (calculated), createdAt only (immutable after creation)

- [X] **T027** [P] Implement PaymentTransaction entity  
  **Files**: `order-management-service/src/main/java/com/ecommerce/order/model/PaymentTransaction.java`  
  **Details**: JPA entity with UUID id, One-to-One to Order (unique constraint), amount (BigDecimal), status (@Enumerated PaymentStatus: PENDING/SUCCESS/FAILED), paymentMethod (String: MOCK/STRIPE), externalTransactionId (nullable), failureReason (nullable, TEXT), attemptCount (@Min(1)), audit fields. Business methods: markAsSuccessful(), markAsFailed()

### Repositories

- [X] **T028** [P] Implement JPA repositories for customer-facing service  
  **Files**: `customer-facing-service/src/main/java/com/ecommerce/customer/repository/CategoryRepository.java`, `ProductRepository.java`, `CartRepository.java`, `CartItemRepository.java`  
  **Details**: Extend JpaRepository<Entity, UUID>. Custom queries: ProductRepository.findByCategoryIdAndIsActive(), CartRepository.findBySessionId(), CartRepository.deleteByExpiresAtBefore() (cleanup job)

- [X] **T029** [P] Implement JPA repositories for order management service  
  **Files**: `order-management-service/src/main/java/com/ecommerce/order/repository/OrderRepository.java`, `OrderItemRepository.java`, `PaymentTransactionRepository.java`, `ProcessedEventRepository.java`  
  **Details**: Extend JpaRepository. Custom queries: OrderRepository.findByOrderNumber(), OrderRepository.findByStatusAndCreatedAtBetween(), ProcessedEventRepository.existsByEventId() (idempotency check)

---

## Phase 3.4: DTOs & Mappers (Priority 4)

**Dependencies**: Entities (T021-T027) must exist

- [X] **T030** [P] Implement DTOs for customer-facing service  
  **Files**: `customer-facing-service/src/main/java/com/ecommerce/customer/dto/` - CategoryDto, CreateCategoryRequest, UpdateCategoryRequest, ProductDto, CreateProductRequest, UpdateProductRequest, CartDto, CartItemDto, AddCartItemRequest, UpdateCartItemRequest, CheckoutRequest, CustomerInfoDto, ShippingAddressDto, CheckoutResponse  
  **Details**: Match OpenAPI schema exactly. Use Bean Validation annotations (@NotNull, @Size, @Pattern, @Email, @DecimalMin). Include builder pattern for readability

- [X] **T031** [P] Implement DTOs for order management service  
  **Files**: `order-management-service/src/main/java/com/ecommerce/order/dto/` - OrderDto, OrderItemDto, CustomerInfoDto, ShippingAddressDto, CancelOrderRequest, FulfillOrderRequest, HealthResponseDto  
  **Details**: Match OpenAPI schema. Include enums (OrderStatus, PaymentStatus)

- [X] **T032** [P] Configure MapStruct mappers for customer-facing service  
  **Files**: `customer-facing-service/src/main/java/com/ecommerce/customer/mapper/CategoryMapper.java`, `ProductMapper.java`, `CartMapper.java`  
  **Details**: @Mapper(componentModel = "spring") for entity ‚Üî DTO conversion. Custom mapping for subtotal calculations, price snapshots

- [X] **T033** [P] Configure MapStruct mappers for order management service  
  **Files**: `order-management-service/src/main/java/com/ecommerce/order/mapper/OrderMapper.java`  
  **Details**: @Mapper for Order ‚Üî OrderDto, handle JSONB address conversion

---

## Phase 3.5: Service Layer (Priority 5)

**Dependencies**: Repositories (T028-T029), DTOs (T030-T033) must exist

### Customer-Facing Service Services

- [X] **T034** Implement CatalogService for category operations  
  **Files**: `customer-facing-service/src/main/java/com/ecommerce/customer/service/CatalogService.java`  
  **Details**: @Service with @Transactional methods: createCategory(), updateCategory(), deleteCategory() (check for products first), listCategories(), getCategoryById(). Throw ResourceNotFoundException if not found

- [X] **T035** Implement CatalogService for product operations  
  **Files**: `customer-facing-service/src/main/java/com/ecommerce/customer/service/CatalogService.java` (extend existing)  
  **Details**: Add methods: createProduct() (validate category exists, check SKU unique), updateProduct() (handle optimistic locking), deleteProduct() (soft delete via isActive=false), listProducts() (with filters and pagination), getProductById()

- [X] **T036** Implement CartService with Redis integration  
  **Files**: `customer-facing-service/src/main/java/com/ecommerce/customer/service/CartService.java`, `config/RedisConfig.java`  
  **Details**: @Service with RedisTemplate<String, Cart> for primary storage. Methods: getCart() (load from Redis or PostgreSQL), addItemToCart() (check product exists, validate inventory, capture price snapshot, update subtotal), updateCartItemQuantity() (validate inventory), removeCartItem(), clearCart(). Sync to PostgreSQL for analytics

- [X] **T037** Implement CheckoutService with inventory decrement  
  **Files**: `customer-facing-service/src/main/java/com/ecommerce/customer/service/CheckoutService.java`  
  **Details**: @Service @Transactional. Method: checkout(sessionId, CustomerInfo) ‚Üí generates orderNumber (format ORD-YYYYMMDD-###), validates cart not empty, decrements inventory (with pessimistic locking: @Lock(PESSIMISTIC_WRITE)), publishes OrderCreatedEvent to Kafka, clears cart, returns CheckoutResponse. Handle insufficient inventory exception

### Order Management Service Services

- [X] **T038** Implement OrderProcessingService (Kafka consumer)  
  **Files**: `order-management-service/src/main/java/com/ecommerce/order/service/OrderProcessingService.java`  
  **Details**: @Service. Method: processOrderCreatedEvent(OrderCreatedEvent) with @Transactional. Check idempotency (ProcessedEventRepository.existsByEventId()), create Order entity (status=PENDING), create OrderItem entities (bulk insert), create PaymentTransaction (status=PENDING), record eventId in processed_events table, trigger payment processing asynchronously

- [X] **T039** Implement PaymentService with mock implementation  
  **Files**: `order-management-service/src/main/java/com/ecommerce/order/payment/PaymentService.java`, `payment/MockPaymentService.java`, `payment/PaymentResult.java`  
  **Details**: Interface PaymentService.processPayment(PaymentRequest) ‚Üí PaymentResult. MockPaymentService always returns success with mock transaction ID. Wrap with @CircuitBreaker("paymentService"). Future: StripePaymentService implementation

- [X] **T040** Implement PaymentCompletedService (event publisher/consumer)  
  **Files**: `order-management-service/src/main/java/com/ecommerce/order/service/PaymentCompletedService.java`  
  **Details**: @Service. Methods: publishPaymentCompleted(PaymentCompletedEvent) ‚Üí send to Kafka, processPaymentCompletedEvent(PaymentCompletedEvent) with @Transactional ‚Üí update PaymentTransaction status, update Order status (PROCESSING ‚Üí PAID or FAILED), record eventId for idempotency

- [X] **T041** Implement OrderQueryService for lookups  
  **Files**: `order-management-service/src/main/java/com/ecommerce/order/service/OrderQueryService.java`  
  **Details**: @Service @Transactional(readOnly=true). Methods: getOrderByNumber(), listOrders() (with filters: status, customerEmail, date range, pagination), cancelOrder() (validate status=PENDING/PROCESSING, update to CANCELLED), fulfillOrder() (validate status=PAID, update to FULFILLED, record tracking info)

---

## Phase 3.6: Event Infrastructure (Priority 6)

**Dependencies**: Service layer (T034-T041) must exist

- [X] **T042** [P] Implement Kafka event publisher in customer-facing service  
  **Files**: `customer-facing-service/src/main/java/com/ecommerce/customer/event/OrderCreatedEventPublisher.java`, `event/OrderCreatedEvent.java`, `config/KafkaProducerConfig.java`  
  **Details**: @Component with KafkaTemplate<String, OrderCreatedEvent>. Method: publishOrderCreated(Order, Cart, CustomerInfo) ‚Üí construct event with correlation ID from MDC, partition key = orderId, send to "orders.created" topic. Configure idempotent producer (acks=all, enable.idempotence=true)

- [X] **T043** [P] Implement Kafka event consumer in order management service  
  **Files**: `order-management-service/src/main/java/com/ecommerce/order/service/OrderProcessingService.java`, `event/OrderCreatedEvent.java`, `config/KafkaConsumerConfig.java`  
  **Details**: @Component with @KafkaListener(topics="orders.created", groupId="order-service-group"). Method: onOrderCreated(ConsumerRecord<String, OrderCreatedEvent>) ‚Üí extract correlation ID to MDC, call OrderProcessingService.processOrderCreatedEvent(), manual ack. Configure manual commit (enable-auto-commit=false)

- [X] **T044** [P] Implement PaymentCompletedEvent publisher/consumer  
  **Files**: `order-management-service/src/main/java/com/ecommerce/order/service/PaymentCompletedService.java`, `event/PaymentCompletedEvent.java`  
  **Details**: Publisher sends to "payments.completed" topic after payment processing. Consumer listens to same topic, calls PaymentCompletedService.processPaymentCompletedEvent() to update order/payment status

---

## Phase 3.7: REST Controllers (Priority 7)

**Dependencies**: Services (T034-T041) must exist, contract tests (T013-T016) still failing

### Customer-Facing Service Controllers

- [X] **T045** [P] Implement CategoryController with Spring Security  
  **Files**: `customer-facing-service/src/main/java/com/ecommerce/customer/controller/CategoryController.java`  
  **Details**: @RestController @RequestMapping("/api/v1/categories"). Endpoints: GET / (public), POST / (@PreAuthorize("hasRole('MANAGER')")), GET /{id} (public), PUT /{id} (manager), DELETE /{id} (manager). Use @Valid for request bodies, ResponseEntity for proper status codes (201 for create, 204 for delete)

- [X] **T046** [P] Implement ProductController with pagination  
  **Files**: `customer-facing-service/src/main/java/com/ecommerce/customer/controller/ProductController.java`  
  **Details**: @RestController @RequestMapping("/api/v1/products"). Endpoints: GET / (public, with filters: categoryId, isActive, pagination), POST / (manager), GET /{id} (public), PUT /{id} (manager), DELETE /{id} (manager). Return Page<ProductDto> for list

- [X] **T047** [P] Implement CartController with session handling  
  **Files**: `customer-facing-service/src/main/java/com/ecommerce/customer/controller/CartController.java`  
  **Details**: @RestController @RequestMapping("/api/v1/carts"). Endpoints: GET /{sessionId}, DELETE /{sessionId}, POST /{sessionId}/items, PUT /{sessionId}/items/{cartItemId}, DELETE /{sessionId}/items/{cartItemId}. Return updated CartDto after mutations

- [X] **T048** Implement CheckoutController with validation  
  **Files**: `customer-facing-service/src/main/java/com/ecommerce/customer/controller/CheckoutController.java`  
  **Details**: @RestController @RequestMapping("/api/v1"). Endpoint: POST /checkout with @Valid CheckoutRequest. Call CheckoutService.checkout(), return 201 with CheckoutResponse. Handle InsufficientInventoryException ‚Üí 409 Conflict

### Order Management Service Controllers

- [X] **T049** [P] Implement OrderController with role-based access  
  **Files**: `order-management-service/src/main/java/com/ecommerce/order/controller/OrderController.java`  
  **Details**: @RestController @RequestMapping("/api/v1/orders"). Endpoints: GET /{orderNumber} (public, guest lookup), GET / (@PreAuthorize("hasRole('MANAGER')"), with filters), POST /{orderNumber}/cancel (manager), POST /{orderNumber}/fulfill (manager). Return OrderDto, handle order not found ‚Üí 404

### Exception Handling

- [X] **T050** [P] Implement global exception handler for both services  
  **Files**: `customer-facing-service/src/main/java/com/ecommerce/customer/exception/GlobalExceptionHandler.java`, `order-management-service/src/main/java/com/ecommerce/order/exception/GlobalExceptionHandler.java`  
  **Details**: @RestControllerAdvice with @ExceptionHandler methods. Handle: ResourceNotFoundException ‚Üí 404, IllegalArgumentException ‚Üí 400, ConstraintViolationException ‚Üí 400, OptimisticLockException ‚Üí 409, DataIntegrityViolationException ‚Üí 409, Exception ‚Üí 500. Return ErrorResponse DTO matching OpenAPI schema. Log exceptions with correlation IDs

---

## Phase 3.8: Security Configuration (Priority 8)

**Dependencies**: Controllers (T045-T049) must exist

- [X] **T051** Configure Spring Security in customer-facing service  
  **Files**: `customer-facing-service/src/main/java/com/ecommerce/customer/config/SecurityConfig.java`  
  **Details**: @Configuration @EnableWebSecurity. Configure HttpSecurity: permit public endpoints (GET /api/v1/products, /api/v1/categories, /api/v1/carts/**, POST /api/v1/checkout, /actuator/health), require ROLE_MANAGER for POST/PUT/DELETE /api/v1/products and /api/v1/categories. OAuth2 Resource Server with JWT validation (mock JWKS endpoint for local dev)

- [X] **T052** [P] Configure Spring Security in order management service  
  **Files**: `order-management-service/src/main/java/com/ecommerce/order/config/SecurityConfig.java`  
  **Details**: @Configuration @EnableWebSecurity. Permit GET /api/v1/orders/{orderNumber} (guest lookup), require ROLE_MANAGER for GET /api/v1/orders, POST /api/v1/orders/*/cancel, POST /api/v1/orders/*/fulfill. OAuth2 Resource Server with JWT validation

- [X] **T053** [P] Implement mock authentication endpoint for local development  
  **Files**: `customer-facing-service/src/main/java/com/ecommerce/customer/controller/AuthController.java`, `service/MockAuthService.java`  
  **Details**: @RestController @RequestMapping("/api/v1/auth"). POST /login with username/password ‚Üí generate mock JWT with role claim (ROLE_MANAGER for username="manager"). Only active in dev profile (@Profile("dev"))

---

## Phase 3.9: Data Access Modernization (Priority 9)

**Dependencies**: Security configuration (T051-T053) complete

**Purpose**: Migrate from Spring Data JPA to Spring Data JDBC for improved performance, transparency, and reduced complexity

**Migration Status**: ‚úÖ COMPLETED (2025-10-05) - Both services successfully migrated, all tests passing

- [X] **T054** Migrate customer-facing service from JPA to Spring Data JDBC
  **Files**: All entity classes in `customer-facing-service/src/main/java/com/ecommerce/customer/model/`, all repositories in `customer-facing-service/src/main/java/com/ecommerce/customer/repository/`, `pom.xml`, service layer, tests
  **Scope**: 7 entities (Category, Product, Cart, CartItem, OrderCreatedOutbox, CheckoutIdempotency, OrderNumberSequence)
  **Status**: ‚úÖ COMPLETED - Migration successful, all tests passing
  **Completed Changes**:
  - Cart ‚Üí CartItem: Aggregate root with `@MappedCollection(idColumn = "cart_id")`
  - Product: Replaced `@ManyToOne Category` with `UUID categoryId`
  - CartItem: Removed back-reference to Cart, stores `UUID productId` instead of Product entity
  - Repositories: Replaced JPQL with SQL, replaced `@Lock(PESSIMISTIC_WRITE)` with `SELECT ... FOR UPDATE`
  - Services: Added explicit `save()` after mutations, manual UUID generation
  - Redis: Removed Hibernate5JakartaModule from Jackson configuration
  - Configuration: Added JdbcConfig, AuditingCallback, PersistableStateCallback
  **Known Minor Issues** (non-blocking):
  - Cart items mapping could be optimized (consider adding `item_index` column or dropping `keyColumn`)
  - Some datasource config in non-standard location (`server.datasource` vs `spring.datasource`)
  - Hibernate logging categories still present in application.yml (can be cleaned up)

- [X] **T055** Migrate order-management service from JPA to Spring Data JDBC
  **Files**: All entity classes in `order-management-service/src/main/java/com/ecommerce/order/model/`, all repositories in `order-management-service/src/main/java/com/ecommerce/order/repository/`, `pom.xml`, service layer, tests
  **Scope**: 4 entities (Order, OrderItem, PaymentTransaction, ProcessedEvent)
  **Status**: ‚úÖ COMPLETED - Migration successful, all tests passing
  **Completed Changes**:
  - Order ‚Üí OrderItem: Aggregate root with `@MappedCollection(idColumn = "order_id")`
  - Order.shippingAddress: Implemented as separate `ShippingAddress` value object with custom JSONB handling
  - PaymentTransaction: Implemented as separate aggregate (decision: independent lifecycle)
  - OrderItem: Removed back-reference to Order, immutable after creation
  - ProcessedEvent: Minimal changes (simple entity)
  - Repositories: Converted JPQL to SQL with explicit ENUM casting (`CAST(:status AS order_status)`)
  - Services: Added explicit save for Order + items, manual UUID generation for nested entities
  - Configuration: Added JdbcConfig with JSONB converters, AuditingCallback
  **Known Minor Issues** (non-blocking):
  - Order items collection uses `Set` but could be standardized to `List` for consistency
  - Auditing callback behavior differs between services (customer service mutates child timestamps, order service only root)
  - Some Hibernate logging categories still present in application.yml

- [ ] **T056** ~~Performance validation: JPA vs JDBC comparison~~ **CANCELLED** (migration complete, benchmarks low-value)
  **Reason**: JDBC migration successful, all tests passing. Benchmarks are academic without performance issues.

- [ ] **T057** Post-migration cleanup and optimization
  **Files**: Both services - `application.yml`, configuration classes, entity models
  **Status**: ‚ö†Ô∏è PARTIALLY DONE - Minor cleanup remaining
  **Remaining Tasks**:
  - Move datasource configuration from `server.datasource` to `spring.datasource` in base profiles (if needed)
  - Remove Hibernate logging categories from `application.yml` (both services)
  - Align cart items mapping: decide on `item_index` column vs dropping `keyColumn`
  - Standardize auditing callback behavior across services (document rationale or unify approach)
  - Optimize checkout product locking (batch-lock products instead of one query per item)
  **Acceptance Criteria**: Configuration cleaned up, documentation updated, no migration artifacts remaining

---

## Phase 3.9.5: Unit Test Coverage (Priority 9.5) üö® URGENT

**Dependencies**: Data access migration (T054-T057) complete
**Blocks**: Integration tests (T058-T063) - unit tests must be comprehensive before integration testing

- [ ] **T092** üö® **URGENT** - Increase unit test coverage on both services to >80% before integration tests
  **Files**:
  - `customer-facing-service/src/test/java/com/ecommerce/customer/service/` - Add unit tests for all service classes
  - `customer-facing-service/src/test/java/com/ecommerce/customer/repository/` - Add repository unit tests
  - `customer-facing-service/src/test/java/com/ecommerce/customer/controller/` - Add controller unit tests
  - `order-management-service/src/test/java/com/ecommerce/order/service/` - Add unit tests for all service classes
  - `order-management-service/src/test/java/com/ecommerce/order/repository/` - Add repository unit tests
  - `order-management-service/src/test/java/com/ecommerce/order/controller/` - Add controller unit tests
  **Status**: ‚ùå NOT DONE - **BLOCKING INTEGRATION TESTS**
  **Priority**: üö® **URGENT** - Must complete before any integration tests (T058-T063)
  **Scope**:
  
  ### Customer-Facing Service Unit Tests Needed:
  1. **Service Layer** (currently minimal coverage):
     - `CatalogService` - test all category/product CRUD operations, error cases, validation
     - `CartService` - test Redis integration (mock RedisTemplate), cart calculations, inventory checks
     - `CheckoutService` - test order number generation, inventory decrement logic, event publishing (mock Kafka)
     - `IdempotencyService` - test key validation, fingerprint matching, response caching
  
  2. **Repository Layer** (test custom queries):
     - `ProductRepository` - test findByCategoryIdAndIsActive, custom SQL queries
     - `CartRepository` - test findBySessionId, deleteByExpiresAtBefore
     - `OrderCreatedOutboxRepository` - test findPendingEvents with status filtering
  
  3. **Controller Layer** (test request/response handling):
     - `CategoryController` - test all endpoints with mock service, validation errors
     - `ProductController` - test pagination, filtering, auth requirements
     - `CartController` - test session handling, error responses
     - `CheckoutController` - test idempotency header enforcement, validation
  
  4. **Event Infrastructure**:
     - `OutboxPublisher` - test polling logic, retry mechanism, status transitions (mock Kafka)
  
  ### Order-Management Service Unit Tests Needed:
  1. **Service Layer**:
     - `OrderProcessingService` - test idempotency checks, order creation, payment triggering
     - `OrderQueryService` - test order lookups, filtering, cancel/fulfill logic with state validation
     - `PaymentCompletedService` - test event publishing/processing, order status updates
     - `MockPaymentService` - test payment processing logic
  
  2. **Repository Layer**:
     - `OrderRepository` - test findByOrderNumber, findByStatusAndCreatedAtBetween with ENUM casting
     - `ProcessedEventRepository` - test existsByEventId for idempotency
  
  3. **Controller Layer**:
     - `OrderController` - test all endpoints with mock service, auth requirements
  
  ### Testing Guidelines:
  - Use `@ExtendWith(MockitoExtension.class)` for unit tests (no Spring context)
  - Mock all dependencies (repositories, external services, Kafka, Redis)
  - Test happy paths AND error cases (not found, validation failures, constraint violations)
  - Test business logic edge cases (inventory insufficient, order state transitions, idempotency)
  - Use `@ParameterizedTest` for testing multiple scenarios
  - Verify mock interactions with `verify()` for critical operations (Kafka publish, inventory decrement)
  - Target: >80% line coverage, >70% branch coverage per service
  
  **Acceptance Criteria**:
  - [ ] Customer-facing service: >80% test coverage on service layer
  - [ ] Customer-facing service: >70% test coverage on repository layer
  - [ ] Customer-facing service: >80% test coverage on controller layer
  - [ ] Order-management service: >80% test coverage on service layer
  - [ ] Order-management service: >70% test coverage on repository layer
  - [ ] Order-management service: >80% test coverage on controller layer
  - [ ] All unit tests pass with `mvn test`
  - [ ] JaCoCo report shows overall coverage >80% for both services
  - [ ] No skipped or ignored tests without documented justification
  
  **Rationale**: Unit tests provide fast feedback, isolate component behavior, and catch regressions early. Integration tests are expensive and slow - they should validate end-to-end flows, not individual component logic. Following the testing pyramid: many unit tests, fewer integration tests, minimal E2E tests.

---

## Phase 3.10: Integration Tests (Priority 10)

**Dependencies**: Unit test coverage (T092) complete, contract tests now passing

- [ ] **T058** [P] Integration test for complete checkout flow
  **Files**: `customer-facing-service/src/test/java/com/ecommerce/customer/integration/CheckoutFlowIntegrationTest.java`
  **Details**: @SpringBootTest with @Testcontainers (PostgreSQL, Redis, Kafka). Scenario: Create category ‚Üí create product ‚Üí add to cart ‚Üí checkout ‚Üí verify OrderCreatedEvent published to Kafka ‚Üí verify inventory decremented ‚Üí verify cart cleared. Use @EmbeddedKafka and KafkaTestConsumer

- [ ] **T058** [P] Integration test for order processing flow
  **Files**: `order-management-service/src/test/java/com/ecommerce/order/integration/OrderProcessingIntegrationTest.java`
  **Details**: @SpringBootTest with @Testcontainers (PostgreSQL, Kafka). Scenario: Publish OrderCreatedEvent ‚Üí verify order created with status=PENDING ‚Üí verify payment processing triggered ‚Üí verify PaymentCompletedEvent published ‚Üí verify order status=PAID ‚Üí verify payment transaction updated

- [ ] **T059** [P] Integration test for idempotency handling
  **Files**: `order-management-service/src/test/java/com/ecommerce/order/integration/IdempotencyIntegrationTest.java`
  **Details**: Publish same OrderCreatedEvent twice (duplicate eventId) ‚Üí verify only one order created, second event logged and skipped

- [ ] **T060** [P] Integration test for cart expiration
  **Files**: `customer-facing-service/src/test/java/com/ecommerce/customer/integration/CartExpirationIntegrationTest.java`
  **Details**: Create cart with short TTL in Redis ‚Üí wait for expiration ‚Üí verify cart not accessible ‚Üí verify cleanup job removes from PostgreSQL

- [ ] **T061** [P] Integration test for payment failure handling
  **Files**: `order-management-service/src/test/java/com/ecommerce/order/integration/PaymentFailureIntegrationTest.java`
  **Details**: Configure MockPaymentService to fail ‚Üí publish OrderCreatedEvent ‚Üí verify order status=FAILED ‚Üí verify PaymentCompletedEvent with status=FAILED and failureReason populated

- [ ] **T062** [P] Integration test for circuit breaker behavior
  **Files**: `order-management-service/src/test/java/com/ecommerce/order/integration/CircuitBreakerIntegrationTest.java`
  **Details**: Configure payment service to timeout ‚Üí trigger 3 payment attempts ‚Üí verify circuit breaker opens ‚Üí verify health check reports circuit breaker OPEN ‚Üí wait for timeout ‚Üí verify circuit breaker transitions to HALF_OPEN

- [ ] **T063** [P] Integration test for manager operations
  **Files**: `order-management-service/src/test/java/com/ecommerce/order/integration/ManagerOperationsIntegrationTest.java`
  **Details**: Create paid order ‚Üí test cancel order (validate status change to CANCELLED) ‚Üí create another paid order ‚Üí test fulfill order (validate status=FULFILLED, tracking info recorded)

---

## Phase 3.11: Deployment & Infrastructure (Priority 11)

**Dependencies**: All integration tests (T057-T063) passing

- [x] **T064** [P] Create optimized Dockerfiles for both services
  **Files**: `customer-facing-service/Dockerfile`, `order-management-service/Dockerfile`
  **Details**: Multi-stage build with Maven dependency caching, Spring Boot layer extraction, security hardening with non-root user, HEALTHCHECK, JVM tuning for containers

- [ ] **T065** [P] Create environment variable template
  **Files**: `.env.example`
  **Status**: ‚ùå NOT DONE
  **Details**: Template for DATABASE_URL, DATABASE_USERNAME, DATABASE_PASSWORD, REDIS_URL, KAFKA_BOOTSTRAP_SERVERS, JWT_SECRET, JWT_ISSUER. Include comments for local vs cloud values. Maintain sync with actual environment variables used in application.yml

---

## Phase 3.12: Observability & Monitoring (Priority 12)

**Dependencies**: Deployment infrastructure (T064-T065) complete

- [X] **T066-T067** ~~Implement custom Micrometer metrics~~ **COMPLETED** (merged into T091, already implemented)
  **Evidence**: `MetricsConfig.java` exists in both services with checkout/cart/order metrics
  **Reason**: Redundant with T091 which was completed. Metrics already exposed via `/actuator/prometheus`

- [ ] **T068** [P] Configure Prometheus scraping for both services
  **Files**: `infrastructure/prometheus/prometheus.yml`, `infrastructure/prometheus/alert-rules.yml`
  **Status**: ‚ùå NOT DONE
  **Details**: Scrape config for /actuator/prometheus endpoints (customer:8080, order:8081). Alert rules: consumer_lag > 1000, payment_success_rate < 0.95, p95_latency > 500ms, service_down

- [ ] **T069** [P] Setup Grafana dashboards
  **Files**: `infrastructure/grafana/dashboards/ecommerce-overview.json`, `order-processing.json`
  **Status**: ‚ùå NOT DONE
  **Details**: Overview dashboard: request rate, error rate, p95 latency, active carts, orders per minute. Order processing dashboard: order status distribution, payment success rate, consumer lag, circuit breaker state

---

## Phase 3.13: Documentation & Polish (Priority 13)

**Dependencies**: All implementation and tests complete

- [X] **T070** [P] Write comprehensive README.md  
  **Files**: `README.md` (root)  
  **Status**: ‚úÖ DONE (2025-10-06)  
  **Evidence**: `README.md` now captures architecture (mermaid diagram), local run playbook, quality gates, deployment workflow, troubleshooting, and ties back to `scripts/validate-quickstart.sh`

- [ ] **T067** [P] AI-driven API documentation sync
  **Files**: `specs/001-e-commerce-platform/contracts/`, AI analysis of code vs specs
  **Details**: Use AI to scan implemented controllers and ensure API contracts in /contracts/ are synchronized with actual code. Update OpenAPI specs if code has evolved beyond initial specs. Maintain drift-free documentation

- [ ] **T068** [P] Write service-specific README files
  **Files**: `customer-facing-service/README.md`, `order-management-service/README.md`
  **Details**: Service-specific architecture, database schema, API endpoints, Kafka topics (producer/consumer), configuration properties, local development setup, testing

- [X] **T071** [P] Create operational runbook
  **Files**: `docs/runbook.md`
  **Status**: ‚úÖ DONE (2025-10-06)
  **Evidence**: `docs/runbook.md` outlines system topology, alert matrix, incident playbooks, routine ops, and escalation paths for both services

- [X] **T072** [P] Create quickstart validation script
  **Files**: `scripts/validate-quickstart.sh`
  **Status**: ‚úÖ DONE (2025-10-06)
  **Evidence**: `scripts/validate-quickstart.sh` seeds catalog via manager JWT, drives cart and checkout, polls order status until PAID, and cleans up artefacts with correlation-aware logging

- [X] **T073** [P] Publish documentation index
  **Files**: `docs/README.md`
  **Status**: ‚úÖ DONE (2025-10-06)
  **Evidence**: `docs/README.md` provides documentation map, contribution guardrails, and cross-links to specs, runbook, and automation assets

---

## Dependencies Graph

```
Setup (T001-T012)
  ‚Üì
Contract Tests (T013-T020) [MUST FAIL]
  ‚Üì
Entities & Repositories (T021-T029)
  ‚Üì
DTOs & Mappers (T030-T033)
  ‚Üì
Service Layer (T034-T041)
  ‚Üì
Event Infrastructure (T042-T044)
  ‚Üì
Controllers (T045-T050) [Contract tests now PASS]
  ‚Üì
Security (T051-T053)
  ‚Üì
Data Access Modernization (T054-T056) [JPA ‚Üí JDBC Migration]
  ‚Üì
Integration Tests (T057-T063)
  ‚Üì
Deployment (T064-T065)
  ‚Üì
Observability (T066-T069)
  ‚Üì
Documentation (T070-T078)
  ‚Üì
Reliability Hardening (T079-T086)
```

**Critical Path Dependencies**:
- T003, T004 (migrations) ‚Üí T021-T027 (entities need tables)
- T021-T027 (entities) ‚Üí T028-T029 (repositories need entities)
- T028-T029 (repositories) ‚Üí T034-T041 (services need repositories)
- T034-T041 (services) ‚Üí T042-T044 (events need services)
- T034-T041 (services) ‚Üí T045-T049 (controllers need services)
- T013-T020 (contract tests) validate T045-T049 (controllers)
- T045-T049 (controllers) ‚Üí T054-T056 (JDBC migration)
- T054-T056 (JDBC migration) ‚Üí T057-T063 (integration tests need full stack)

---

## Parallel Execution Examples

### Setup Phase (All Parallel)
```bash
# All independent infrastructure tasks
Task T002: "Create Docker Compose infrastructure"
Task T003: "Configure Flyway migrations for customer service"
Task T004: "Configure Flyway migrations for order service"
Task T005: "Create Kafka topic configuration"
Task T006: "Configure customer service application.yml"
Task T007: "Configure order service application.yml"
Task T008: "Configure Resilience4j in customer service"
Task T009: "Configure Resilience4j in order service"
Task T010: "Setup Micrometer and Prometheus"
Task T011: "Configure Actuator health checks"
Task T012: "Setup structured logging"
```

### Contract Tests Phase (All Parallel - Different Test Files)
```bash
# All independent test files
Task T013: "Category endpoints contract tests"
Task T014: "Product endpoints contract tests"
Task T015: "Cart endpoints contract tests"
Task T016: "Checkout endpoint contract tests"
Task T017: "Order endpoints contract tests"
Task T018: "Health endpoints contract tests"
Task T019: "OrderCreatedEvent schema contract tests"
Task T020: "PaymentCompletedEvent schema contract tests"
```

### Entity Models Phase (All Parallel - Different Entity Files)
```bash
# All independent entity files
Task T021: "Category entity"
Task T022: "Product entity"
Task T023: "Cart entity"
Task T024: "CartItem entity"
Task T025: "Order entity"
Task T026: "OrderItem entity"
Task T027: "PaymentTransaction entity"
Task T028: "Customer service repositories"
Task T029: "Order service repositories"
```

### Integration Tests Phase (All Parallel - Different Test Files)
```bash
# All independent integration tests
Task T057: "Checkout flow integration test"
Task T058: "Order processing integration test"
Task T059: "Idempotency integration test"
Task T060: "Cart expiration integration test"
Task T061: "Payment failure integration test"
Task T062: "Circuit breaker integration test"
Task T063: "Manager operations integration test"
```

---

## Task Validation Checklist

**Contract Coverage**:
- [x] All 15 customer service endpoints have contract tests (T013-T016)
- [x] All 5 order service endpoints have contract tests (T017-T018)
- [x] All 2 Kafka events have schema contract tests (T019-T020)

**Entity Coverage**:
- [x] All 7 entities have model tasks (T021-T027: Category, Product, Cart, CartItem, Order, OrderItem, PaymentTransaction)
- [x] All entities have corresponding repository tasks (T028-T029)

**TDD Workflow**:
- [x] Contract tests (Phase 3.2) come before implementation (Phase 3.3+)
- [x] Integration tests (Phase 3.9) come after all implementation
- [x] Contract tests explicitly marked as "MUST FAIL" before implementation

**Parallelization**:
- [x] All [P] tasks operate on different files or independent modules
- [x] No [P] tasks have dependencies on each other
- [x] Sequential tasks within same file not marked [P]

**Completeness**:
- [x] All user stories from quickstart.md covered (checkout flow T054, manager operations T060)
- [x] All resilience patterns covered (circuit breaker T059, retry in T008-T009)
- [x] All observability requirements covered (metrics T066-T067, health checks T011, logging T012)
- [x] All security requirements covered (JWT auth T051-T053, role-based access in controllers)

**File Paths**:
- [x] All tasks include exact file paths
- [x] Paths follow plan.md structure (multi-module Maven: customer-facing-service/, order-management-service/)

---

## Notes for Implementation Agents

1. **TDD is Mandatory**: Do not implement T021-T053 until contract tests (T013-T020) are written and failing
2. **Testcontainers**: Integration tests (T054-T060) use Testcontainers for PostgreSQL, Redis, Kafka - ensure Docker is running
3. **Idempotency**: Critical for Kafka consumers (T038, T040) - always check ProcessedEventRepository before processing
4. **Optimistic Locking**: Product entity (T022) uses @Version - handle OptimisticLockException in checkout (T037)
5. **Circuit Breaker**: PaymentService (T039) wrapped with @CircuitBreaker - test open/closed states (T059)
6. **Correlation IDs**: Set in controller filters, propagate to MDC, include in all logs and events
7. **JSON Logging**: Use structured logging (T012) with correlation IDs for traceability across services
8. **Database Migrations**: Flyway migrations (T003-T004) are immutable - never edit V1, create V6 for changes
9. **Environment Parity**: Use same PostgreSQL/Redis/Kafka versions locally (docker-compose.yml T002) and prod (k8s T062-T064)
10. **Health Checks**: Actuator health (T011) reflects circuit breaker state, database connectivity, Kafka consumer status

---

## Success Criteria

**Phase 3.2 (Contract Tests)**: All contract tests written, all failing (expected - no implementation yet)
**Phase 3.7 (Controllers)**: All contract tests now passing, 100% API coverage
**Phase 3.9 (Data Access)**: JPA to JDBC migration complete, all tests passing with new data access layer
**Phase 3.10 (Integration)**: All integration tests passing, end-to-end flows validated
**Phase 3.11 (Deployment)**: Services deployable via `docker-compose up`, accessible via curl
**Phase 3.13 (Documentation)**: Quickstart validation script (T072) executes successfully, API docs synchronized

**Final Validation**:
- [ ] All 92 tasks completed (T001-T092)
- [ ] Contract tests: 100% passing (20 test files)
- [ ] Unit tests: >80% coverage on both services (T092)
- [ ] Integration tests: 100% passing (7 test files)
- [ ] Code coverage: >80% (services and controllers)
- [ ] SonarQube: 0 bugs, 0 vulnerabilities (T073)
- [ ] Quickstart script: Executes without errors (T072)
- [ ] Health checks: All services UP (T011)
- [ ] Metrics: Exposed at /actuator/prometheus (T010)
- [ ] Data access: Spring Data JDBC migration complete (T054-T056)

---

**Tasks Generation Complete**: 92 numbered, dependency-ordered, parallel-marked tasks ready for execution
**Estimated Effort**: 370-475 developer-hours (assuming 4-5 hours per task average)
**Recommended Team Size**: 3-4 developers (pair on critical paths, parallelize independent tasks)
**Timeline**: 8-10 weeks for full implementation with testing, documentation, and JDBC migration

---

## Phase 3.14: Reliability & Operational Hardening (Priority 14)

~~**DEPRECATED**: Tasks T079-T086 are duplicates of T087-T091 below. All reliability features already implemented.~~

**Status**: ‚úÖ ALL COMPLETED via T087-T091 (see Urgent Remediation section below)


## Urgent Remediation Tasks (Priority 0)

**Status**: ‚úÖ ALL COMPLETED (implemented without updating tasks.md - see evidence below)

- [X] **T087** Harden checkout with persisted Idempotency-Key workflow ‚úÖ **COMPLETED**
  **Evidence**:
  - `IdempotencyService.java` exists with key‚Üífingerprint‚Üíresponse caching
  - `CheckoutIdempotency` entity + repository exist
  - V7 migration: `V7__create_idempotency_table.sql` exists
  - `CheckoutController.java` enforces `Idempotency-Key` header
  **Implementation**: Fully compliant with FR-043 - 24h TTL, fingerprint validation, cached response replay

- [X] **T088** Implement transactional outbox publishing for OrderCreated events ‚úÖ **COMPLETED**
  **Evidence**:
  - `OutboxPublisher.java` with @Scheduled background polling (every 5s)
  - `OrderCreatedOutbox` entity with PENDING/PUBLISHED/FAILED status
  - V8 migration: `V8__create_outbox_table.sql` exists
  - `OrderCreatedOutboxRepository` with findPendingEvents query
  - Checkout persists outbox + order data in single transaction
  **Implementation**: Exactly-once semantics with retry (max 5) and DLQ (FAILED status)

- [X] **T089** Standardize API errors on RFC 7807 Problem Details ‚úÖ **COMPLETED**
  **Evidence**:
  - `GlobalExceptionHandler.java` uses Spring `ProblemDetail`
  - Returns `application/problem+json` with `type`, `title`, `status`, `detail`, `instance`
  - Attaches `correlationId` via `problem.setProperty()`
  - Implemented in both customer-facing and order-management services
  **Implementation**: Full RFC 7807 compliance

- [X] **T090** Switch logging to structured JSON with correlation propagation ‚úÖ **COMPLETED**
  **Evidence**:
  - `logback-spring-prod.xml` uses `LogstashEncoder` for JSON logs
  - MDC includes: correlationId, userId, sessionId, traceId, spanId
  - Custom fields: service name, environment
  - Separate profiles: dev (human-readable), prod/stg (JSON)
  **Implementation**: Full structured logging with correlation ID propagation

- [X] **T091** Backfill RED/business metrics instrumentation ‚úÖ **COMPLETED**
  **Evidence**:
  - `MetricsConfig.java` in both services with business metrics:
    - Customer service: checkout.attempts.total, checkout.success.total, checkout.failures.total, cart.items.added.total, checkout.duration (timer with p50/p95/p99)
    - Order service: orders.created.total, payments.success/failed.total, orders.cancelled/fulfilled.total
  - Metrics exposed via `/actuator/prometheus`
  **Implementation**: Full RED (Rate, Errors, Duration) + business KPI coverage
